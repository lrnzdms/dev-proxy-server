name: Bump Version, Build, and Publish to NPM

on:
  workflow_call:
    inputs:
      BUILD_CMD:
        required: true
        type: string
      VERSION_BUMP: # 'major', 'minor', 'patch' => v{major}.{minor}.{patch}
        required: true
        type: string

jobs:
  bump_build_publish:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '20'

    - name: Configure git
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        
    # - name: Configure npm
    #   run: |
    #     echo "//npm.pkg.github.com/:_authToken=${{ secrets.NPM_TOKEN }}" > .npmrc
    #     echo "@btrlty:registry=https://npm.pkg.github.com" >> .npmrc
        
    - name: Bump version
      id: bump_version
      run: |
        npm version ${{ inputs.VERSION_BUMP }} -m "Bump version to %s"
        echo "::set-output name=new_version::$(node -p -e "require('./package.json').version")"

    - name: Install dependencies
      run: npm install

    - name: Build project
      run: npm run ${{ github.event.inputs.BUILD_CMD }}

    - name: Publish to NPM
      run: npm publish
      
    - name: Delete existing tag if it exists
      run: |
        git tag -d v${{ steps.bump_version.outputs.new_version }} || true
        git push origin :refs/tags/v${{ steps.bump_version.outputs.new_version }} || true

    - name: Commit bumped version and build
      run: |
        git add .
        git diff-index --quiet HEAD || git commit -m "Release version ${{ steps.bump_version.outputs.new_version }}"
        git tag v${{ steps.bump_version.outputs.new_version }}
        git push origin HEAD --tags